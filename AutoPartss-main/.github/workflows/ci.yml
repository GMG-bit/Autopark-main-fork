name: CI/CD Pipeline con Docker y Calidad

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - main

jobs:
  build-test-security:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      # --- 7. CONFIGURACI√ìN DE GITHUB ADVANCED SECURITY (INICIO) ---
      # Debe ir antes de cualquier paso de construcci√≥n o prueba.
      - name: üìù Initialize CodeQL (Advanced Security)
        uses: github/codeql-action/init@v3
        with:
          languages: python

      # --- 1. CONFIGURACI√ìN DE DOCKER HUB ---
      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # --- 2. CONSTRUCCI√ìN DE LA IMAGEN DOCKER (√öNICA VEZ) ---
      # Construye y etiqueta la imagen para uso local en el runner. No publica a√∫n.
      - name: üì¶ Build and Tag Docker Image for Local Use
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false 
          tags: ${{ secrets.DOCKER_USERNAME }}/autoparts:latest

      # --- 3. EJECUCI√ìN DE PRUEBAS UNITARIAS ---
      # Ejecuta la imagen reci√©n construida para las pruebas.
      - name: üß™ Run Unit Tests inside Container
        run: |
          docker run ${{ secrets.DOCKER_USERNAME }}/autoparts:latest python backend/manage.py test

# =================================================================
#  PARTE 2: AN√ÅLISIS DE C√ìDIGO Y SEGURIDAD
# =================================================================

      # --- 4. INTEGRACI√ìN SONARCLOUD (AN√ÅLISIS EST√ÅTICO DE CALIDAD) ---
      - name: üîç SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
# ... antes del paso 5 (Snyk)
      - name: üêç Setup Python 3.11 for Snyk and CodeQL
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Usa una versi√≥n moderna y soportada

      # --- 5. INTEGRACI√ìN SNYK ...(
      # --- 5. INTEGRACI√ìN SNYK (VULNERABILIDADES DE C√ìDIGO Y DEPENDENCIAS) ---
      - name: üõ°Ô∏è Snyk Vulnerability Scan (Code & Dependencies)
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --sarif-file-output=snyk-code.sarif --file=requirements.txt

      # --- 6. INTEGRACI√ìN DOCKER SCOUT (AN√ÅLISIS DE IMAGEN DOCKER) ---
      - name: üê≥ Docker Scout Security Scan
        # Nota: Docker Scout ahora est√° incluido en Docker CLI v24.0+. Simplificaremos la instalaci√≥n.
        run: |
          # El escaneo de CVEs se realiza sobre la imagen ya construida.
          # Usamos --exit-code 1 para detener el pipeline si hay fallos cr√≠ticos.
          docker scout cves --exit-code 1 ${{ secrets.DOCKER_USERNAME }}/autoparts:latest

      # --- 7. CONFIGURACI√ìN DE GITHUB ADVANCED SECURITY (FIN) ---
      # Esto genera el reporte de CodeQL.
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # --- 8. PUBLICACI√ìN FINAL EN DOCKER HUB ---
      # Si todos los pasos anteriores (pruebas, Sonar, Snyk, CodeQL y Docker Scout) fueron exitosos, se publica.
      - name: üöÄ Push Final Image to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/autoparts:latest